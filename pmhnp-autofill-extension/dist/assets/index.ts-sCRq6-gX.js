import{L as N,A as f,a as L,E as A,P,b as c,T as I,c as T}from"./constants-BdnQFqPF.js";import{a as u,b as R,d as y,s as _,e as O,i as S,f as k,c as d}from"./errorHandler-CHgNGPzP.js";async function F(){const e=await chrome.tabs.create({url:N});if(e.id)return new Promise(t=>{const a=(n,o)=>{n!==e.id||!o.url||o.url.includes(A)&&(chrome.tabs.onUpdated.removeListener(a),l().then(()=>{e.id&&chrome.tabs.remove(e.id).catch(()=>{}),t()}).catch(E=>{console.error("[PMHNP] Failed to get extension token:",E),t()}))};chrome.tabs.onUpdated.addListener(a);const r=n=>{n===e.id&&(chrome.tabs.onRemoved.removeListener(r),chrome.tabs.onUpdated.removeListener(a),t())};chrome.tabs.onRemoved.addListener(r)})}async function l(){try{const e=await fetch(`${f}${L}`,{method:"GET",credentials:"include",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error(`Extension token request failed: ${e.status}`);const t=await e.json(),a={isLoggedIn:!0,user:{userId:t.userId,email:t.email,firstName:t.firstName},token:t.token,expiresAt:t.expiresAt};return await _(a),a}catch(e){return console.error("[PMHNP] getExtensionToken failed:",e),{isLoggedIn:!1,user:null,token:null,expiresAt:null}}}async function h(){return u()}async function m(){await R(),await y()}async function b(){const e=await u();if(!e.isLoggedIn||!e.token)throw new Error("Not authenticated");if(e.expiresAt){const t=new Date(e.expiresAt).getTime(),a=5*60*1e3;if(t-Date.now()<a)try{const r=await l();if(r.isLoggedIn&&r.token)return{Authorization:`Bearer ${r.token}`}}catch{if(t<Date.now())throw await m(),new Error("Session expired — please log in again")}}return{Authorization:`Bearer ${e.token}`}}async function x(){const e=await u();if(e.isLoggedIn&&e.expiresAt){const t=new Date(e.expiresAt).getTime(),a=30*60*1e3;if(t-Date.now()<a)try{await l()}catch(r){console.warn("[PMHNP] Token refresh failed:",r)}}}async function i(e=!1){if(!e){const n=await O();if(n&&!await S())return n.data}const t=await b(),a=await fetch(`${f}${P}`,{headers:{...t,"Content-Type":"application/json"}});if(!a.ok)throw a.status===401?new Error("Unauthorized — please log in again"):new Error(`Profile fetch failed: ${a.status}`);const r=await a.json();return await k(r),r}function H(e){const t=[];let a=0,r=0;const n=(s,g,p=!1)=>{r++,s!=null&&s!==""?a++:p&&t.push(g)};n(e.personal.firstName,"First Name",!0),n(e.personal.lastName,"Last Name",!0),n(e.personal.email,"Email",!0),n(e.personal.phone,"Phone"),n(e.personal.address.line1,"Address"),n(e.personal.address.city,"City"),n(e.personal.address.state,"State"),n(e.personal.address.zip,"ZIP Code"),n(e.credentials.npiNumber,"NPI Number"),n(e.credentials.deaNumber,"DEA Number"),n(e.credentials.licenses.length>0?!0:null,"At least 1 License"),n(e.credentials.certifications.length>0?!0:null,"At least 1 Certification"),n(e.education.length>0?!0:null,"Education"),n(e.workExperience.length>0?!0:null,"Work Experience"),n(e.meta.resumeUrl,"Resume");const o=r>0?Math.round(a/r*100):0;return{ready:t.filter(s=>["First Name","Last Name","Email"].includes(s)).length===0,missing:t,completeness:o}}chrome.runtime.onInstalled.addListener(async()=>{console.log("[PMHNP] Extension installed"),chrome.alarms.create(c.TOKEN_REFRESH,{periodInMinutes:I}),chrome.alarms.create(c.PROFILE_REFRESH,{periodInMinutes:T});try{(await h()).isLoggedIn&&await i()}catch(e){d(e,"onInstalled profile fetch")}});chrome.alarms.onAlarm.addListener(async e=>{try{e.name===c.TOKEN_REFRESH?await x():e.name===c.PROFILE_REFRESH&&(await h()).isLoggedIn&&(await i(!0),w({type:"PROFILE_UPDATED"}))}catch(t){d(t,`alarm:${e.name}`)}});chrome.runtime.onMessage.addListener((e,t,a)=>(D(e).then(a).catch(r=>{d(r,`message:${e.type}`),a({error:r instanceof Error?r.message:"Unknown error"})}),!0));async function D(e){switch(e.type){case"LOGIN":return await F(),{success:!0};case"LOGOUT":return await m(),{success:!0};case"GET_AUTH_STATE":return h();case"GET_PROFILE":return await i();case"REFRESH_PROFILE":{const t=await i(!0);return w({type:"PROFILE_UPDATED"}),t}case"GET_PROFILE_READINESS":{const t=await i();return H(t)}default:return{error:`Unknown message type: ${e.type}`}}}function w(e){chrome.tabs.query({},t=>{for(const a of t)a.id&&chrome.tabs.sendMessage(a.id,e).catch(()=>{})})}
