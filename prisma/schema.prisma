generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

model Job {
  id                    String    @id @default(uuid())
  title                 String
  employer              String
  location              String
  jobType               String?   @map("job_type")
  mode                  String?
  description           String
  descriptionSummary    String?   @map("description_summary")
  salaryRange           String?   @map("salary_range")
  minSalary             Int?      @map("min_salary")
  maxSalary             Int?      @map("max_salary")
  salaryPeriod          String?   @map("salary_period")
  
  // Parsed location data
  city                  String?
  state                 String?
  stateCode             String?   @map("state_code")
  country               String?   @default("US")
  isRemote              Boolean   @default(false) @map("is_remote")
  isHybrid              Boolean   @default(false) @map("is_hybrid")
  
  // Normalized salary fields (always annual)
  normalizedMinSalary   Int?      @map("normalized_min_salary")
  normalizedMaxSalary   Int?      @map("normalized_max_salary")
  salaryIsEstimated     Boolean   @default(false) @map("salary_is_estimated")
  salaryConfidence      Float?    @map("salary_confidence")
  
  applyLink             String    @map("apply_link")
  isFeatured            Boolean   @default(false) @map("is_featured")
  isPublished           Boolean   @default(true) @map("is_published")
  isVerifiedEmployer    Boolean   @default(false) @map("is_verified_employer")
  sourceType            String?   @map("source_type")
  sourceProvider        String?   @map("source_provider")
  externalId            String?   @map("external_id")
  viewCount             Int       @default(0) @map("view_count")
  applyClickCount       Int       @default(0) @map("apply_click_count")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  expiresAt             DateTime? @map("expires_at")
  
  // Company relation
  companyId             String?   @map("company_id")
  company               Company?  @relation(fields: [companyId], references: [id])
  
  employerJobs          EmployerJob[]
  applyClicks           ApplyClick[]

  @@index([isPublished])
  @@index([isFeatured])
  @@index([location])
  @@index([createdAt(sort: Desc)])
  @@index([minSalary, maxSalary])
  @@index([state])
  @@index([isRemote])
  @@index([companyId])
  @@map("jobs")
}

model EmailLead {
  id               String   @id @default(cuid())
  email            String   @unique
  preferences      Json     @default("{}")
  source           String?
  isSubscribed     Boolean  @default(true) @map("is_subscribed")
  unsubscribeToken String   @unique @default(cuid()) @map("unsubscribe_token")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  jobAlerts        JobAlert[]

  @@index([email])
  @@index([unsubscribeToken])
  @@map("email_leads")
}

model JobAlert {
  id          String    @id @default(cuid())
  email       String
  name        String?   // Optional: "Remote CA jobs"

  // Search criteria
  keyword     String?
  location    String?
  mode        String?   // Remote, Hybrid, In-Person
  jobType     String?   @map("job_type") // Full-Time, Part-Time, Contract, Per Diem
  minSalary   Int?      @map("min_salary")
  maxSalary   Int?      @map("max_salary")

  // Settings
  frequency   String    @default("weekly") // daily, weekly
  isActive    Boolean   @default(true) @map("is_active")

  // Tracking
  lastSentAt  DateTime? @map("last_sent_at")
  token       String    @unique @default(cuid()) // For manage/delete

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relation (optional - can exist without EmailLead)
  emailLead   EmailLead? @relation(fields: [email], references: [email])

  @@index([email])
  @@index([token])
  @@index([isActive])
  @@map("job_alerts")
}

model EmployerJob {
  id                  String    @id @default(uuid())
  employerName        String    @map("employer_name")
  contactEmail        String    @map("contact_email")
  companyLogoUrl      String?   @map("company_logo_url")
  companyDescription  String?   @map("company_description")
  companyWebsite      String?   @map("company_website")
  jobId               String    @unique @map("job_id")
  editToken           String    @unique @map("edit_token")
  dashboardToken      String    @unique @default(cuid()) @map("dashboard_token")
  // Valid values: 'pending', 'paid', 'failed', 'refunded', 'free', 'free_renewed', 'free_upgraded'
  paymentStatus       String    @map("payment_status")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  expiryWarningSentAt DateTime? @map("expiry_warning_sent_at")

  job                 Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([editToken])
  @@index([contactEmail])
  @@index([dashboardToken])
  @@map("employer_jobs")
}

model SiteStat {
  id                String   @id @default(uuid())
  totalJobs         Int      @default(0) @map("total_jobs")
  totalSubscribers  Int      @default(0) @map("total_subscribers")
  totalCompanies    Int      @default(0) @map("total_companies")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("site_stats")
}

model JobDraft {
  id          String   @id @default(cuid())
  email       String
  formData    Json     @map("form_data")
  resumeToken String   @unique @default(cuid()) @map("resume_token")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  expiresAt   DateTime @map("expires_at")

  @@index([email])
  @@index([resumeToken])
  @@map("job_drafts")
}

model Company {
  id              String   @id @default(uuid())
  name            String   @unique  // Canonical name
  normalizedName  String   @unique @map("normalized_name")  // For matching
  aliases         String[] @default([])  // Alternative names
  logoUrl         String?  @map("logo_url")
  website         String?
  description     String?
  jobCount        Int      @default(0) @map("job_count")
  isVerified      Boolean  @default(false) @map("is_verified")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  jobs            Job[]
  
  @@index([normalizedName])
  @@index([isVerified])
  @@map("companies")
}

model SourceStats {
  id              String   @id @default(uuid())
  source          String   // adzuna, jooble, etc.
  date            DateTime @db.Date  // Stats for this day
  jobsFetched     Int      @default(0) @map("jobs_fetched")
  jobsAdded       Int      @default(0) @map("jobs_added")
  jobsDuplicate   Int      @default(0) @map("jobs_duplicate")
  jobsExpired     Int      @default(0) @map("jobs_expired")
  avgQualityScore Float?   @map("avg_quality_score")
  totalViews      Int      @default(0) @map("total_views")
  totalApplyClicks Int     @default(0) @map("total_apply_clicks")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@unique([source, date])
  @@index([source])
  @@index([date])
  @@map("source_stats")
}

model ApplyClick {
  id              String   @id @default(uuid())
  jobId           String   @map("job_id")
  job             Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  source          String?  // Job's sourceProvider
  timestamp       DateTime @default(now())
  sessionId       String?  @map("session_id")  // For deduping
  referrer        String?  // Where user came from
  userAgent       String?  @map("user_agent")
  
  @@index([jobId])
  @@index([source])
  @@index([timestamp])
  @@map("apply_clicks")
}

model EmployerLead {
  id              String   @id @default(uuid())
  companyName     String   @map("company_name")
  contactName     String?  @map("contact_name")
  contactEmail    String?  @map("contact_email")
  contactTitle    String?  @map("contact_title")
  website         String?
  linkedInUrl     String?  @map("linkedin_url")
  notes           String?
  status          String   @default("prospect")  // prospect, contacted, responded, converted, declined
  source          String?  // where we found them
  lastContactedAt DateTime? @map("last_contacted_at")
  nextFollowUpAt  DateTime? @map("next_follow_up_at")
  jobsPosted      Int      @default(0) @map("jobs_posted")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@index([status])
  @@index([companyName])
  @@map("employer_leads")
}
